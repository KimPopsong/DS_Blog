---
import { Image } from 'astro:assets';
import { getCollection } from 'astro:content';
import { readFile } from 'fs/promises';
import { join } from 'path';
import BaseHead from '../../components/BaseHead.astro';
import Footer from '../../components/Footer.astro';
import FormattedDate from '../../components/FormattedDate.astro';
import Header from '../../components/Header.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../../consts';

const allPosts = (await getCollection('blog')).sort(
	(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);

// Ìè¨Ïä§Ìä∏ Î≥∏Î¨∏ ÎÇ¥Ïö© Ï∂îÏ∂ú (Í≤ÄÏÉâÏö©)
const postsWithContent = await Promise.all(
	allPosts.map(async (post) => {
		let bodyText = '';
		try {
			// ÎßàÌÅ¨Îã§Ïö¥ ÌååÏùº Í≤ΩÎ°ú Íµ¨ÏÑ±
			const filePath = join(process.cwd(), 'src', 'content', 'blog', `${post.id}.md`);
			const fileContent = await readFile(filePath, 'utf-8');
			
			// frontmatter Ï†úÍ±∞ÌïòÍ≥† Î≥∏Î¨∏Îßå Ï∂îÏ∂ú
			const frontmatterEnd = fileContent.indexOf('---', 3);
			if (frontmatterEnd !== -1) {
				bodyText = fileContent.substring(frontmatterEnd + 3).trim();
				// ÎßàÌÅ¨Îã§Ïö¥ Î¨∏Î≤ï Ï†úÍ±∞ (Í∞ÑÎã®Ìïú Î≤ÑÏ†Ñ)
				bodyText = bodyText
					.replace(/^#+\s+/gm, '') // Ìó§Îçî Ï†úÍ±∞
					.replace(/\[([^\]]+)\]\([^\)]+\)/g, '$1') // ÎßÅÌÅ¨ Ï†úÍ±∞
					.replace(/!\[([^\]]*)\]\([^\)]+\)/g, '') // Ïù¥ÎØ∏ÏßÄ Ï†úÍ±∞
					.replace(/\*\*([^\*]+)\*\*/g, '$1') // Î≥ºÎìú Ï†úÍ±∞
					.replace(/\*([^\*]+)\*/g, '$1') // Ïù¥ÌÉ§Î¶≠ Ï†úÍ±∞
					.replace(/`([^`]+)`/g, '$1') // Ïù∏ÎùºÏù∏ ÏΩîÎìú Ï†úÍ±∞
					.replace(/```[\s\S]*?```/g, '') // ÏΩîÎìú Î∏îÎ°ù Ï†úÍ±∞
					.replace(/\n+/g, ' ') // Ï§ÑÎ∞îÍøàÏùÑ Í≥µÎ∞±ÏúºÎ°ú
					.trim()
					.substring(0, 1000); // ÏµúÎåÄ 1000Ïûê
			}
		} catch (e) {
			// ÌååÏùº ÏùΩÍ∏∞ Ïã§Ìå® Ïãú description ÏÇ¨Ïö©
			bodyText = post.data.description || '';
		}
		
		return {
			...post,
			bodyText: bodyText,
		};
	})
);

const featuredPost = postsWithContent[0];
const otherPosts = postsWithContent.slice(1); // ÎÇòÎ®∏ÏßÄ Î™®Îì† Ìè¨Ïä§Ìä∏

// Í≤ÄÏÉâÏö© Îç∞Ïù¥ÌÑ∞ Ï§ÄÎπÑ (Ï†úÎ™©, ÏÑ§Î™Ö, ÌÉúÍ∑∏, ÎÇ¥Ïö©)
const searchData = postsWithContent.map((post) => ({
	id: post.id,
	title: post.data.title,
	description: post.data.description,
	tags: post.data.tags || [],
	content: post.bodyText,
	heroImage: post.data.heroImage?.src || null,
	pubDate: post.data.pubDate.toISOString(),
}));
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
		<style>
			main {
				max-width: 1400px;
				width: 100%;
				padding: 4em 2em;
			}
			.page-title {
				font-size: 3.5rem;
				font-weight: 700;
				margin-bottom: 0.5em;
				background: linear-gradient(135deg, rgb(var(--black)) 0%, var(--accent-glow) 100%);
				-webkit-background-clip: text;
				-webkit-text-fill-color: transparent;
				background-clip: text;
				text-align: center;
			}
			.posts-container {
				display: flex;
				flex-direction: column;
				gap: 2rem;
				list-style-type: none;
				margin: 3rem 0 0 0;
				padding: 0;
			}
			.posts-list {
				display: grid;
				grid-template-columns: repeat(2, 1fr);
				gap: 2rem;
				list-style-type: none;
				margin: 0;
				padding: 0;
			}
			.post-item {
				opacity: 0;
				transform: translateY(20px);
				transition: opacity 0.6s ease, transform 0.6s ease;
			}
			.post-item.visible {
				opacity: 1;
				transform: translateY(0);
			}
			.post-item.hidden {
				display: none;
			}
			.no-results {
				grid-column: 1 / -1;
				text-align: center;
				padding: 4rem 2rem;
				color: rgb(var(--gray));
			}
			.no-results h3 {
				font-size: 1.5rem;
				margin-bottom: 0.5rem;
				color: rgb(var(--black));
			}
			.loading-indicator {
				grid-column: 1 / -1;
				text-align: center;
				padding: 2rem;
				color: rgb(var(--gray));
				display: none;
			}
			.loading-indicator.active {
				display: block;
			}
			.post-card {
				display: flex;
				flex-direction: row;
				background: var(--card-bg);
				border: 1px solid var(--card-border);
				border-radius: 16px;
				overflow: hidden;
				transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
				text-decoration: none;
				position: relative;
			}
			.post-card::before {
				content: '';
				position: absolute;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				background: linear-gradient(135deg, rgba(79, 140, 255, 0.1) 0%, transparent 100%);
				opacity: 0;
				transition: opacity 0.4s ease;
				pointer-events: none;
			}
			.post-card:hover {
				transform: translateY(-8px);
				border-color: var(--accent);
				box-shadow: var(--neon-glow), 0 20px 40px rgba(0, 0, 0, 0.4);
			}
			.post-card:hover::before {
				opacity: 1;
			}
			.featured-card {
				flex-direction: row;
			}
			.post-image-wrapper {
				width: 40%;
				flex-shrink: 0;
				overflow: hidden;
			}
			.featured-card .post-image-wrapper {
				width: 50%;
			}
			.post-image {
				width: 100%;
				height: 100%;
				min-height: 200px;
				object-fit: cover;
				display: block;
				transition: transform 0.4s ease;
			}
			.featured-card .post-image {
				min-height: 350px;
			}
			.post-card:hover .post-image {
				transform: scale(1.05);
			}
			.post-content {
				padding: 1.5rem;
				display: flex;
				flex-direction: column;
				flex: 1;
				justify-content: center;
			}
			.featured-card .post-content {
				padding: 2.5rem;
			}
			.post-title {
				margin: 0 0 0.75rem 0;
				color: rgb(var(--black));
				line-height: 1.3;
				font-size: 1.2rem;
				font-weight: 600;
				transition: color 0.3s ease;
				display: -webkit-box;
				-webkit-line-clamp: 2;
				-webkit-box-orient: vertical;
				overflow: hidden;
				word-break: keep-all;
			}
			.featured-card .post-title {
				font-size: 1.8rem;
				-webkit-line-clamp: 2;
				margin-bottom: 1rem;
			}
			.post-card:hover .post-title {
				color: var(--accent-glow);
			}
			.post-date {
				margin: 0 0 0.75rem 0;
				color: rgb(var(--gray));
				font-size: 0.85rem;
				display: flex;
				align-items: center;
				gap: 0.5rem;
			}
			.post-date::before {
				content: 'üìÖ';
				font-size: 1rem;
			}
			.post-tags {
				display: flex;
				flex-wrap: wrap;
				gap: 0.5rem;
				margin-top: auto;
				padding-top: 0.5rem;
			}
			.post-tag {
				display: inline-block;
				padding: 0.4rem 0.8rem;
				background: rgba(79, 140, 255, 0.1);
				border: 1px solid var(--card-border);
				border-radius: 6px;
				color: var(--accent);
				font-size: 0.85rem;
				transition: all 0.3s ease;
			}
			.post-card:hover .post-tag {
				background: rgba(79, 140, 255, 0.2);
				border-color: var(--accent);
			}
			@media (max-width: 1024px) {
				.posts-list {
					grid-template-columns: 1fr;
				}
				.featured-card,
				.post-card {
					flex-direction: column;
				}
				.post-image-wrapper,
				.featured-card .post-image-wrapper {
					width: 100%;
				}
				.post-image,
				.featured-card .post-image {
					min-height: 250px;
				}
			}
			@media (max-width: 720px) {
				main {
					padding: 2em 1em;
				}
				.page-title {
					font-size: 2.5rem;
				}
				.posts-container {
					gap: 1.5rem;
				}
				.posts-list {
					grid-template-columns: 1fr;
					gap: 1.5rem;
				}
				.featured-card .post-content {
					padding: 1.5rem;
				}
				.featured-card .post-title {
					font-size: 1.4rem;
				}
				.post-content {
					padding: 1.25rem;
				}
				.post-title {
					font-size: 1.1rem;
				}
			}
		</style>
	</head>
	<body>
		<Header />
		<main>
			<h1 class="page-title">Blog Posts</h1>
			<ul class="posts-container">
				{featuredPost && (
					<li>
						<a href={`/blog/${featuredPost.id}/`} class="post-card featured-card">
							{featuredPost.data.heroImage && (
								<div class="post-image-wrapper">
									<Image
										width={720}
										height={360}
										src={featuredPost.data.heroImage}
										alt=""
										class="post-image"
									/>
								</div>
							)}
							<div class="post-content">
								<h2 class="post-title">{featuredPost.data.title}</h2>
								<p class="post-date">
									<FormattedDate date={featuredPost.data.pubDate} />
								</p>
								{featuredPost.data.tags && featuredPost.data.tags.length > 0 && (
									<div class="post-tags">
										{featuredPost.data.tags.slice(0, 3).map((tag) => (
											<span class="post-tag">{tag}</span>
										))}
									</div>
								)}
							</div>
						</a>
					</li>
				)}
				{otherPosts.length > 0 && (
					<ul class="posts-list" id="posts-list">
						{
							otherPosts.map((post, index) => (
								<li class="post-item" data-index={index} data-post-id={post.id}>
									<a href={`/blog/${post.id}/`} class="post-card">
										{post.data.heroImage && (
											<div class="post-image-wrapper">
												<Image
													width={720}
													height={360}
													src={post.data.heroImage}
													alt=""
													class="post-image"
												/>
											</div>
										)}
										<div class="post-content">
											<h2 class="post-title">{post.data.title}</h2>
											<p class="post-date">
												<FormattedDate date={post.data.pubDate} />
											</p>
											{post.data.tags && post.data.tags.length > 0 && (
												<div class="post-tags">
													{post.data.tags.slice(0, 3).map((tag) => (
														<span class="post-tag">{tag}</span>
													))}
												</div>
											)}
										</div>
									</a>
								</li>
							))
						}
						<li class="loading-indicator" id="loading-indicator">
							Î°úÎî© Ï§ë...
						</li>
						<li class="no-results" id="no-results" style="display: none;">
							<h3>Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§</h3>
							<p>Îã§Î•∏ ÌÇ§ÏõåÎìúÎ°ú Í≤ÄÏÉâÌï¥Î≥¥ÏÑ∏Ïöî.</p>
						</li>
					</ul>
				)}
			</ul>
		</main>
		<Footer />
		<script define:vars={{ searchData }}>
			(function() {
				const postsList = document.getElementById('posts-list');
				const loadingIndicator = document.getElementById('loading-indicator');
				const noResults = document.getElementById('no-results');
				const searchInput = document.getElementById('search-input');
				let postItems = Array.from(document.querySelectorAll('.post-item'));
				let featuredCard = document.querySelector('.featured-card')?.closest('li');
				
				if (!postsList || postItems.length === 0) return;
				
				let visibleCount = 4; // Ï¥àÍ∏∞Ïóê 4Í∞úÎßå Î≥¥Ïù¥Í≤å (2Ï§Ñ)
				let isLoading = false;
				let isSearchMode = false;
				
				// Í≤ÄÏÉâ Ìï®Ïàò
				function searchPosts(query) {
					if (!query || query.trim() === '') {
						isSearchMode = false;
						// Í≤ÄÏÉâ Î™®Îìú Ìï¥Ï†ú - Î™®Îì† Ìè¨Ïä§Ìä∏ ÌëúÏãú
						postItems.forEach((item, index) => {
							item.classList.remove('hidden');
							if (index < visibleCount) {
								item.classList.add('visible');
							} else {
								item.classList.remove('visible');
							}
						});
						if (featuredCard) featuredCard.style.display = '';
						noResults.style.display = 'none';
						loadingIndicator.style.display = visibleCount < postItems.length ? 'block' : 'none';
						return;
					}
					
					isSearchMode = true;
					const searchTerm = query.toLowerCase().trim();
					
					// Í≤ÄÏÉâ Ïã§Ìñâ
					const matchingPostIds = searchData
						.filter((post) => {
							const titleMatch = post.title.toLowerCase().includes(searchTerm);
							const descriptionMatch = post.description.toLowerCase().includes(searchTerm);
							const tagsMatch = post.tags.some(tag => tag.toLowerCase().includes(searchTerm));
							const contentMatch = post.content.toLowerCase().includes(searchTerm);
							return titleMatch || descriptionMatch || tagsMatch || contentMatch;
						})
						.map(post => post.id);
					
					// Featured Ïπ¥Îìú Ïà®Í∏∞Í∏∞
					if (featuredCard) featuredCard.style.display = 'none';
					
					// Í≤ÄÏÉâ Í≤∞Í≥º ÌëúÏãú
					let visibleInSearch = 0;
					postItems.forEach((item) => {
						const postId = item.getAttribute('data-post-id');
						if (matchingPostIds.includes(postId)) {
							item.classList.remove('hidden');
							item.classList.add('visible');
							visibleInSearch++;
						} else {
							item.classList.add('hidden');
							item.classList.remove('visible');
						}
					});
					
					// Í≤ÄÏÉâ Í≤∞Í≥º ÏóÜÏùå Î©îÏãúÏßÄ
					if (visibleInSearch === 0) {
						noResults.style.display = 'block';
						loadingIndicator.style.display = 'none';
					} else {
						noResults.style.display = 'none';
						loadingIndicator.style.display = 'none';
					}
				}
				
				// Í≤ÄÏÉâ ÏûÖÎ†• Ïù¥Î≤§Ìä∏
				if (searchInput) {
					let searchTimeout;
					searchInput.addEventListener('input', (e) => {
						clearTimeout(searchTimeout);
						searchTimeout = setTimeout(() => {
							searchPosts(e.target.value);
						}, 300); // ÎîîÎ∞îÏö¥Ïä§ 300ms
					});
				}
				
				// Ï¥àÍ∏∞ Ìè¨Ïä§Ìä∏ ÌëúÏãú
				function showInitialPosts() {
					postItems.forEach((item, index) => {
						if (index < visibleCount) {
							setTimeout(() => {
								item.classList.add('visible');
							}, index * 100);
						}
					});
				}
				
				// Ï∂îÍ∞Ä Ìè¨Ïä§Ìä∏ Î°úÎìú
				function loadMorePosts() {
					if (isSearchMode || isLoading || visibleCount >= postItems.length) {
						if (visibleCount >= postItems.length) {
							loadingIndicator?.classList.remove('active');
						}
						return;
					}
					
					isLoading = true;
					loadingIndicator?.classList.add('active');
					
					// Îã§Ïùå 2Í∞ú Ìè¨Ïä§Ìä∏ ÌëúÏãú (Ìïú Ï§ÑÏóê 2Í∞ú)
					const nextCount = Math.min(visibleCount + 2, postItems.length);
					
					setTimeout(() => {
						for (let i = visibleCount; i < nextCount; i++) {
							if (postItems[i]) {
								setTimeout(() => {
									postItems[i].classList.add('visible');
								}, (i - visibleCount) * 100);
							}
						}
						
						visibleCount = nextCount;
						isLoading = false;
						
						if (visibleCount >= postItems.length) {
							loadingIndicator?.classList.remove('active');
						}
					}, 300);
				}
				
				// Intersection ObserverÎ°ú Ïä§ÌÅ¨Î°§ Í∞êÏßÄ
				const observerOptions = {
					root: null,
					rootMargin: '200px',
					threshold: 0.1
				};
				
				const observer = new IntersectionObserver((entries) => {
					entries.forEach(entry => {
						if (entry.isIntersecting) {
							loadMorePosts();
						}
					});
				}, observerOptions);
				
				// Ï¥àÍ∏∞ Ìè¨Ïä§Ìä∏ ÌëúÏãú
				showInitialPosts();
				
				// Î°úÎî© Ïù∏ÎîîÏºÄÏù¥ÌÑ∞ Í¥ÄÏ∞∞ ÏãúÏûë
				if (visibleCount < postItems.length) {
					loadingIndicator?.classList.add('active');
					observer.observe(loadingIndicator);
				}
			})();
		</script>
	</body>
</html>
