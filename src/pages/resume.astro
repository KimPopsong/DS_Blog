---
import { getCollection, render } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import Header from '../components/Header.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../consts';

// Resume 마크다운 파일 가져오기
const resumeEntries = await getCollection('resume');
const resumeEntry = resumeEntries[0]; // 첫 번째 resume 파일 사용

let Content;
if (resumeEntry) {
	const rendered = await render(resumeEntry);
	Content = rendered.Content;
}
---

<!doctype html>
<html lang="ko">
	<head>
		<BaseHead title={`Resume | ${SITE_TITLE}`} description={SITE_DESCRIPTION} />
		<style>
			body {
				margin: 0 !important;
				padding: 0 !important;
			}
			main {
				max-width: 1000px !important;
				width: 100% !important;
				margin-left: auto !important;
				margin-right: auto !important;
				margin-top: 0 !important;
				margin-bottom: 0 !important;
				padding: 4rem 2em !important;
				display: block !important;
				box-sizing: border-box !important;
				text-align: left !important;
				position: relative !important;
			}
			@media (max-width: 840px) {
				main {
					width: calc(100% - 4em) !important;
					max-width: calc(100% - 4em) !important;
				}
			}
			.resume-content {
				background: var(--card-bg);
				border: 1px solid var(--card-border);
				border-radius: 20px;
				padding: 4rem 4rem;
				box-shadow: var(--neon-glow), 0 20px 60px rgba(0, 0, 0, 0.5);
				width: 100%;
				box-sizing: border-box;
				margin: 0 auto;
				display: block;
			}
			.resume-content :global(h1) {
				font-size: 2.5rem;
				font-weight: 700;
				margin: 0 0 1rem 0;
				color: rgb(var(--black));
				line-height: 1.2;
			}
			.resume-content :global(blockquote) {
				margin: 1.5rem 0 3rem 0;
				padding: 0;
				border-left: none;
				font-size: 1.1rem;
				color: rgb(var(--gray-dark));
				line-height: 1.8;
				font-style: italic;
			}
			.resume-content :global(blockquote p) {
				margin: 0.5rem 0;
			}
			.resume-content :global(h2) {
				font-size: 1.5rem;
				font-weight: 600;
				margin: 2rem 0 1rem 0;
				color: rgb(var(--black));
				display: flex;
				align-items: center;
				gap: 0.5rem;
			}
			.resume-content :global(hr) {
				border: none;
				border-top: 1px solid var(--card-border);
				margin: 2rem 0;
			}
			.resume-content :global(h3) {
				font-size: 1.2rem;
				margin: 1.5rem 0 0.75rem 0;
				color: rgb(var(--black));
				font-weight: 600;
			}
			.resume-content :global(p) {
				font-size: 1rem;
				color: rgb(var(--gray-dark));
				line-height: 1.8;
				margin: 0.75rem 0;
			}
			.resume-content :global(strong) {
				font-weight: 600;
				color: rgb(var(--black));
			}
			.resume-content :global(ul), .resume-content :global(ol) {
				margin: 1rem 0;
				padding-left: 1.5rem;
			}
			.resume-content :global(li) {
				margin: 0.5rem 0;
				color: rgb(var(--gray-dark));
				line-height: 1.8;
				font-size: 1rem;
			}
			.resume-content :global(img) {
				border-radius: 12px;
				border: 1px solid var(--card-border);
				box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
			}
			/* 프로필 섹션 레이아웃 */
			.resume-content :global(.profile-container) {
				display: flex;
				gap: 2rem;
				align-items: flex-start;
				margin: 2rem 0;
			}
			.resume-content :global(.profile-image) {
				flex-shrink: 0;
			}
			.resume-content :global(.profile-info) {
				flex: 1;
			}
			.resume-content :global(.profile-info > p:first-child) {
				margin-top: 0 !important;
			}
			.resume-content :global(.profile-info > p:first-child:has(strong)) {
				margin-top: 0 !important;
			}
			/* Activities 섹션 레이아웃 */
			.resume-content :global(.activities-container) {
				display: flex;
				flex-direction: column;
				gap: 1.5rem;
				margin: 2rem 0;
			}
			.resume-content :global(.activity-item) {
				display: flex;
				gap: 2rem;
				align-items: baseline;
				margin-bottom: 0;
			}
			.resume-content :global(.activity-left) {
				flex: 1;
			}
			.resume-content :global(.activity-right) {
				flex: 1;
			}
			.resume-content :global(.activity-left > p:first-child) {
				margin-top: 0 !important;
				margin-bottom: 0 !important;
				line-height: 1.8;
			}
			.resume-content :global(.activity-right > ul) {
				margin-top: 0;
				margin-bottom: 0;
				padding-top: 0;
				padding-left: 1.5rem;
			}
			.resume-content :global(.activity-right > ul > li:first-child) {
				margin-top: 0;
			}
			/* Awards 섹션 레이아웃 */
			.resume-content :global(.awards-container) {
				display: flex;
				flex-direction: column;
				gap: 1.5rem;
				margin: 2rem 0;
			}
			.resume-content :global(.awards-item) {
				display: flex;
				gap: 2rem;
				align-items: baseline;
				margin-bottom: 0;
			}
			.resume-content :global(.awards-left) {
				flex: 1;
			}
			.resume-content :global(.awards-right) {
				flex: 1;
			}
			.resume-content :global(.awards-left > p:first-child) {
				margin-top: 0 !important;
				margin-bottom: 0 !important;
				line-height: 1.8;
			}
			.resume-content :global(.awards-right > ul) {
				margin-top: 0;
				margin-bottom: 0;
				padding-top: 0;
				padding-left: 1.5rem;
			}
			.resume-content :global(.awards-right > ul > li:first-child) {
				margin-top: 0;
			}
			/* Certifications 섹션 레이아웃 */
			.resume-content :global(.certifications-container) {
				display: flex;
				flex-direction: column;
				gap: 1.5rem;
				margin: 2rem 0;
			}
			.resume-content :global(.certification-item) {
				display: flex;
				gap: 2rem;
				align-items: baseline;
				margin-bottom: 0;
			}
			.resume-content :global(.certification-left) {
				flex: 1;
			}
			.resume-content :global(.certification-right) {
				flex: 1;
			}
			.resume-content :global(.certification-left > p:first-child) {
				margin-top: 0 !important;
				margin-bottom: 0 !important;
				line-height: 1.8;
			}
			.resume-content :global(.certification-right > ul) {
				margin-top: 0;
				margin-bottom: 0;
				padding-top: 0;
				padding-left: 1.5rem;
			}
			.resume-content :global(.certification-right > ul > li:first-child) {
				margin-top: 0;
			}
			/* Educations 섹션 레이아웃 */
			.resume-content :global(.educations-container) {
				display: flex;
				flex-direction: column;
				gap: 1.5rem;
				margin: 2rem 0;
			}
			.resume-content :global(.education-item) {
				display: flex;
				gap: 2rem;
				align-items: baseline;
				margin-bottom: 0;
			}
			.resume-content :global(.education-left) {
				flex: 1;
			}
			.resume-content :global(.education-right) {
				flex: 1;
			}
			.resume-content :global(.education-left > p:first-child) {
				margin-top: 0 !important;
				margin-bottom: 0 !important;
				line-height: 1.8;
			}
			.resume-content :global(.education-right > ul) {
				margin-top: 0;
				margin-bottom: 0;
				padding-top: 0;
				padding-left: 1.5rem;
			}
			.resume-content :global(.education-right > ul > li:first-child) {
				margin-top: 0;
			}
			/* ETC 섹션 레이아웃 */
			.resume-content :global(.etc-container) {
				display: flex;
				flex-direction: column;
				gap: 1.5rem;
				margin: 2rem 0;
			}
			.resume-content :global(.etc-item) {
				display: flex;
				gap: 2rem;
				align-items: baseline;
				margin-bottom: 0;
			}
			.resume-content :global(.etc-left) {
				flex: 1;
			}
			.resume-content :global(.etc-right) {
				flex: 1;
			}
			.resume-content :global(.etc-left > p:first-child) {
				margin-top: 0 !important;
				margin-bottom: 0 !important;
				line-height: 1.8;
			}
			.resume-content :global(.etc-right > ul) {
				margin-top: 0;
				margin-bottom: 0;
				padding-top: 0;
				padding-left: 1.5rem;
			}
			.resume-content :global(.etc-right > ul > li:first-child) {
				margin-top: 0;
			}
			/* 인라인 스타일이 있는 div도 지원 */
			.resume-content :global(div[style*="display: flex"]) {
				display: flex !important;
				gap: 2rem;
				align-items: flex-start;
				margin: 2rem 0;
			}
			.resume-content :global(div[style*="display: flex"] > div:first-child) {
				flex-shrink: 0;
			}
			.resume-content :global(div[style*="display: flex"] > div:last-child) {
				flex: 1;
			}
			.resume-content :global(a) {
				color: var(--accent);
				text-decoration: none;
				transition: color 0.3s ease;
			}
			.resume-content :global(a:hover) {
				color: var(--accent-glow);
				text-decoration: underline;
			}
			/* Profile 섹션 스타일 - 이미지와 텍스트를 나란히 배치 */
			.resume-content :global(h2:has(+ hr)) {
				margin-top: 3rem;
			}
			/* 프로필 이미지 다음에 오는 정보들을 깔끔하게 정리 */
			/* 프로필 정보 스타일 */
			.resume-content :global(p:has(strong)) {
				margin-top: 1.25rem;
				margin-bottom: 0.5rem;
			}
			.resume-content :global(p:has(strong) + p) {
				margin-top: 0;
				margin-bottom: 1.25rem;
			}
			/* Activities 섹션 날짜 스타일 */
			.resume-content :global(p:not(:has(strong)):not(:has(a))) {
				margin: 0.5rem 0;
			}
			/* 다운로드 버튼 섹션 */
			.download-section {
				display: flex;
				justify-content: center;
				margin-top: 3rem;
				padding-top: 2rem;
			}
			.download-button {
				display: flex;
				align-items: center;
				gap: 0.75rem;
				padding: 1rem 2rem;
				background: var(--accent);
				border: 1px solid var(--accent);
				border-radius: 12px;
				color: rgb(var(--black));
				font-size: 1rem;
				font-weight: 600;
				cursor: pointer;
				transition: all 0.3s ease;
				box-shadow: var(--neon-glow);
			}
			.download-button:hover {
				background: var(--accent-glow);
				transform: translateY(-2px);
				box-shadow: var(--neon-glow), 0 10px 30px rgba(79, 140, 255, 0.4);
			}
			.download-button:active {
				transform: translateY(0);
			}
			.download-button svg {
				flex-shrink: 0;
			}
			/* PDF 생성용 스타일 */
			.resume-content.pdf-mode {
				box-shadow: none !important;
				border: none !important;
				border-radius: 0 !important;
				padding: 2rem !important;
				background: #0f1423 !important;
				max-width: 100% !important;
				width: 100% !important;
				text-align: left !important;
			}
			.resume-content.pdf-mode :global(*) {
				text-align: left !important;
			}
			.resume-content.pdf-mode :global(h1),
			.resume-content.pdf-mode :global(h2),
			.resume-content.pdf-mode :global(h3),
			.resume-content.pdf-mode :global(p),
			.resume-content.pdf-mode :global(li),
			.resume-content.pdf-mode :global(ul),
			.resume-content.pdf-mode :global(ol),
			.resume-content.pdf-mode :global(blockquote),
			.resume-content.pdf-mode :global(div) {
				text-align: left !important;
			}
			@media print {
				header, footer, .download-section {
					display: none !important;
				}
				.resume-content {
					box-shadow: none;
					border: none;
					padding: 2rem;
				}
			}
			@media (max-width: 1024px) {
				main {
					width: calc(100% - 4em) !important;
					max-width: calc(100% - 4em) !important;
					padding: 3rem 1.5em !important;
					margin-left: auto !important;
					margin-right: auto !important;
				}
				.resume-content {
					padding: 3rem 3rem;
					max-width: 100%;
					box-sizing: border-box;
					margin: 0 auto;
				}
			}
			@media (max-width: 720px) {
				main {
					width: calc(100% - 2em) !important;
					max-width: calc(100% - 2em) !important;
					padding: 2rem 1em !important;
					margin-left: auto !important;
					margin-right: auto !important;
				}
				.resume-content {
					padding: 2rem 2rem;
					border-radius: 16px;
					box-sizing: border-box;
					margin: 0 auto;
				}
				.resume-content :global(h1) {
					font-size: 2rem;
				}
				.resume-content :global(blockquote) {
					font-size: 1rem;
					margin: 1rem 0 2rem 0;
				}
				.resume-content :global(h2) {
					font-size: 1.3rem;
					margin: 1.5rem 0 0.75rem 0;
				}
				.resume-content :global(h3) {
					font-size: 1.1rem;
				}
				.resume-content :global(p) {
					font-size: 0.95rem;
				}
				.resume-content :global(li) {
					font-size: 0.95rem;
				}
				.resume-content :global(.profile-container),
				.resume-content :global(.activities-container),
				.resume-content :global(.activity-item),
				.resume-content :global(.awards-container),
				.resume-content :global(.awards-item),
				.resume-content :global(.certifications-container),
				.resume-content :global(.certification-item),
				.resume-content :global(.educations-container),
				.resume-content :global(.education-item),
				.resume-content :global(.etc-container),
				.resume-content :global(.etc-item),
				.resume-content :global(div[style*="display: flex"]) {
					flex-direction: column !important;
					gap: 1.5rem;
				}
				.resume-content :global(.profile-image),
				.resume-content :global(div[style*="display: flex"] > div:first-child) {
					align-self: center;
				}
			}
			@media (max-width: 480px) {
				main {
					width: calc(100% - 1.5em) !important;
					max-width: calc(100% - 1.5em) !important;
					padding: 1.5rem 0.75em !important;
					margin-left: auto !important;
					margin-right: auto !important;
				}
				.resume-content {
					padding: 1.5rem 1.5rem;
					border-radius: 16px;
					box-sizing: border-box;
					margin: 0 auto;
				}
				.resume-content :global(h1) {
					font-size: 1.75rem;
				}
				.resume-content :global(blockquote) {
					font-size: 0.95rem;
				}
				.resume-content :global(h2) {
					font-size: 1.2rem;
					margin: 1.5rem 0 0.75rem 0;
				}
				.resume-content :global(h3) {
					font-size: 1rem;
				}
				.resume-content :global(p) {
					font-size: 0.9rem;
				}
				.resume-content :global(li) {
					font-size: 0.9rem;
				}
				.resume-content :global(img) {
					max-width: 200px;
				}
			}
		</style>
	</head>
	<body>
		<Header />
		<main>
			<div class="resume-content" id="resume-content">
				{Content ? <Content /> : <p>이력서를 작성해주세요.</p>}
			</div>
			<div class="download-section">
				<button id="download-pdf" class="download-button">
					<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
						<polyline points="7 10 12 15 17 10"></polyline>
						<line x1="12" y1="15" x2="12" y2="3"></line>
					</svg>
					다운로드
				</button>
			</div>
		</main>
		<Footer />
		<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
		<script>
			document.addEventListener('DOMContentLoaded', function() {
				const downloadButton = document.getElementById('download-pdf');
				const resumeContent = document.getElementById('resume-content');
				
				if (downloadButton && resumeContent) {
					downloadButton.addEventListener('click', async function() {
						// 버튼 비활성화
						downloadButton.disabled = true;
						const originalHTML = downloadButton.innerHTML;
						downloadButton.innerHTML = '<span>PDF 생성 중...</span>';
						
						try {
							// 이미지 로딩 대기
							const images = resumeContent.querySelectorAll('img');
							await Promise.all(
								Array.from(images).map(img => {
									if (img.complete && img.naturalHeight !== 0) return Promise.resolve();
									return new Promise((resolve) => {
										img.onload = resolve;
										img.onerror = resolve; // 에러가 나도 계속 진행
										setTimeout(resolve, 5000); // 최대 5초 대기
									});
								})
							);
							
							// PDF 모드 클래스 추가 (스타일 보정용)
							resumeContent.classList.add('pdf-mode');
							
							// PDF 옵션 설정
							const opt = {
								margin: [15, 15, 15, 15],
								filename: '김대성_이력서.pdf',
								image: { 
									type: 'jpeg', 
									quality: 0.95 
								},
								html2canvas: { 
									scale: 2,
									useCORS: true,
									allowTaint: false,
									letterRendering: true,
									backgroundColor: '#0f1423',
									width: resumeContent.scrollWidth,
									height: resumeContent.scrollHeight,
									windowWidth: resumeContent.scrollWidth,
									windowHeight: resumeContent.scrollHeight,
									x: 0,
									y: 0,
									scrollX: 0,
									scrollY: 0,
									logging: false,
									onclone: function(clonedDoc) {
										// 클론된 문서의 html, body 스타일 수정
										const clonedHtml = clonedDoc.documentElement;
										const clonedBody = clonedDoc.body;
										
										if (clonedHtml) {
											clonedHtml.style.margin = '0';
											clonedHtml.style.padding = '0';
											clonedHtml.style.textAlign = 'left';
										}
										
										if (clonedBody) {
											clonedBody.style.margin = '0';
											clonedBody.style.padding = '0';
											clonedBody.style.textAlign = 'left';
											clonedBody.style.width = '100%';
											clonedBody.style.maxWidth = '100%';
											clonedBody.style.overflow = 'visible';
										}
										
										// 클론된 문서의 main 요소 제거 또는 스타일 수정
										const clonedMain = clonedDoc.querySelector('main');
										if (clonedMain) {
											clonedMain.style.margin = '0';
											clonedMain.style.padding = '0';
											clonedMain.style.width = 'auto';
											clonedMain.style.maxWidth = 'none';
											clonedMain.style.textAlign = 'left';
										}
										
										// 클론된 문서에서 스타일 보정
										const clonedContent = clonedDoc.getElementById('resume-content');
										if (clonedContent) {
											// PDF용 스타일 적용
											clonedContent.style.width = resumeContent.scrollWidth + 'px';
											clonedContent.style.maxWidth = resumeContent.scrollWidth + 'px';
											clonedContent.style.minWidth = resumeContent.scrollWidth + 'px';
											clonedContent.style.boxShadow = 'none';
											clonedContent.style.border = 'none';
											clonedContent.style.borderRadius = '0';
											clonedContent.style.padding = '2rem';
											clonedContent.style.background = '#0f1423';
											clonedContent.style.margin = '0 auto';
											clonedContent.style.marginLeft = 'auto';
											clonedContent.style.marginRight = 'auto';
											clonedContent.style.textAlign = 'left';
											clonedContent.style.display = 'block';
											
											// 모든 이미지가 로드되었는지 확인
											const imgs = clonedContent.querySelectorAll('img');
											imgs.forEach(img => {
												img.style.maxWidth = '100%';
												img.style.height = 'auto';
												img.style.display = 'block';
											});
											
											// 모든 텍스트 요소의 text-align을 left로 설정
											const textElements = clonedContent.querySelectorAll('h1, h2, h3, h4, h5, h6, p, li, ul, ol, blockquote, div, span, a, strong, em');
											textElements.forEach(el => {
												el.style.textAlign = 'left';
												el.style.transform = 'none';
												el.style.transition = 'none';
											});
											
											// 모든 요소의 transform과 transition 제거
											const allElements = clonedContent.querySelectorAll('*');
											allElements.forEach(el => {
												if (!el.style.textAlign) {
													el.style.textAlign = 'left';
												}
												el.style.transform = 'none';
												el.style.transition = 'none';
											});
										}
									}
								},
								jsPDF: { 
									unit: 'mm', 
									format: 'a4', 
									orientation: 'portrait',
									compress: true
								},
								pagebreak: { 
									mode: ['avoid-all', 'css', 'legacy'],
									before: '.page-break-before',
									after: '.page-break-after',
									avoid: ['img', '.profile-container']
								}
							};
							
							// PDF 생성 및 다운로드
							await html2pdf()
								.set(opt)
								.from(resumeContent)
								.save();
							
							// PDF 모드 클래스 제거
							resumeContent.classList.remove('pdf-mode');
							
							// 완료 후 버튼 복원
							downloadButton.disabled = false;
							downloadButton.innerHTML = originalHTML;
						} catch (error) {
							console.error('PDF 생성 오류:', error);
							// PDF 모드 클래스 제거
							if (resumeContent) {
								resumeContent.classList.remove('pdf-mode');
							}
							alert('PDF 생성 중 오류가 발생했습니다: ' + error.message);
							downloadButton.disabled = false;
							downloadButton.innerHTML = originalHTML;
						}
					});
				}
			});
		</script>
	</body>
</html>
